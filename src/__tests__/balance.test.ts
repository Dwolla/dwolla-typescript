/*
 * Code originally generated by Speakeasy (https://www.speakeasy.com).
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createDwollaClient, createPersonalCustomer } from "./setup.js";

let dwolla: Dwolla;
let balanceFundingSourceId: string | undefined;

beforeAll(async () => {
  dwolla = createDwollaClient("balance");
  const customerId = await createPersonalCustomer(dwolla);

  // List customer funding sources and find the balance funding source
  const fundingSources = await dwolla.customers.fundingSources.list({
    id: customerId,
  });

  // Find the balance funding source (type === "balance")
  const balanceFundingSource = fundingSources.embedded?.fundingSources?.find(
    (fs) => fs.type === "balance"
  );

  if (balanceFundingSource?.id) {
    balanceFundingSourceId = balanceFundingSource.id;
  }
}, 30000); // 30 second timeout for setup initialization

test("Balance Get Funding Source Balance", async () => {

  const result = await dwolla.fundingSources.balance.get({
    id: balanceFundingSourceId!,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.lastUpdated).toBeDefined();

  // Check for Dwolla Balance response (has balance and total)
  if ("balance" in result) {
    expect(result.balance).toBeDefined();
    expect(result.balance.value).toBeDefined();
    expect(result.balance.currency).toBeDefined();
    expect(result.total).toBeDefined();
    expect(result.total.value).toBeDefined();
    expect(result.total.currency).toBeDefined();
  }

  // Check for Bank Balance response (has available and closing)
  if ("available" in result) {
    expect(result.available).toBeDefined();
    expect(result.closing).toBeDefined();
  }
});
