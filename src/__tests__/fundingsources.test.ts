/*
 * Code originally generated by Speakeasy (https://www.speakeasy.com).
 * Consolidated funding sources tests - covers funding sources and microdeposits.
 * Creates a single customer with funding sources for all tests.
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createDwollaClient, createPersonalCustomer, extractIdFromLocationHeader } from "./setup.js";

let dwolla: Dwolla;
let virtualFundingSourceId: string | undefined;
let bankFundingSourceId: string | undefined;

beforeAll(async () => {
  dwolla = createDwollaClient("fundingsources");
  
  // Create a personal customer for funding source testing
  const customerId = await createPersonalCustomer(dwolla);

  // Create a virtual funding source for basic tests
  try {
    const virtualResult = await dwolla.customers.fundingSources.create({
      id: customerId,
      createCustomerFundingSource: {
        name: "Test Virtual Account",
        type: "virtual",
        bankAccountType: "checking",
      },
    });
    virtualFundingSourceId = extractIdFromLocationHeader(virtualResult?.headers);
  } catch (e) {
    console.log("Note: Could not create virtual funding source:", e);
  }

  // Create a bank funding source for microdeposit tests
  // Note: Sandbox routing number 222222226 auto-verifies, so microdeposits will be skipped
  const uniqueAccountNumber = String(Date.now());
  try {
    const bankResult = await dwolla.customers.fundingSources.create({
      id: customerId,
      createCustomerFundingSource: {
        name: "Microdeposit Test Bank",
        bankAccountType: "checking",
        routingNumber: "222222226",
        accountNumber: uniqueAccountNumber,
        verified: false
      },
    });
    bankFundingSourceId = extractIdFromLocationHeader(bankResult?.headers);
    
  } catch (e) {
    console.log("Note: Could not create bank funding source:", e);
  }

  // Initiate Microdeposits for testing
  try {
    await dwolla.fundingSources.microDeposits.initiate({
      id: bankFundingSourceId!,
    });
  } catch (e) {
    console.log("Note: Could not initiate microdeposits:", e);
  }
}, 30000);

// ============================================================================
// FUNDING SOURCES TESTS
// ============================================================================

test("Fundingsources Get Funding Source", async () => {

  const result = await dwolla.fundingSources.get({
    id: virtualFundingSourceId!,
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.type).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
  expect(result.name).toBeDefined();
  expect(result.removed).toBeDefined();
  expect(result.channels).toBeDefined();
  
  if (result.type === "bank") {
    expect(result.bankAccountType).toBeDefined();
  }
});

test("Fundingsources Get Van Routing", async () => {

  const result = await dwolla.fundingSources.getVanRouting({
    id: virtualFundingSourceId!,
  });
  expect(result).toBeDefined();
  expect(result.accountNumber).toBeDefined();
  expect(result.routingNumber).toBeDefined();
});

test("Fundingsources Update Or Remove Funding Source", async () => {

  const result = await dwolla.fundingSources.updateOrRemove({
    id: virtualFundingSourceId!,
    requestBody: {
      removed: true,
    },
  });
  expect(result).toBeDefined();
  expect(result).toEqual({});
});

// ============================================================================
// MICRODEPOSITS TESTS
// Note: Sandbox routing number 222222226 creates auto-verified accounts,
// so microdeposit initiation will return 404. These tests are skipped in sandbox.
// ============================================================================

test("Fundingsources Get Micro Deposits", async () => {

  const result = await dwolla.fundingSources.microDeposits.get({
    id: bankFundingSourceId!,
  });
  expect(result).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.status).toBeDefined();
  expect(result.links).toBeDefined();
  
  if (result.failure) {
    expect(result.failure.code).toBeDefined();
    expect(result.failure.description).toBeDefined();
  }
});

test("Fundingsources Verify Micro Deposits", async () => {
  
  const result = await dwolla.fundingSources.microDeposits.verify({
    id: bankFundingSourceId!,
    requestBody: {
      amount1: {
        value: "0.02",
        currency: "USD",
      },
      amount2: {
        value: "0.03",
        currency: "USD",
      },
    },
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
});

