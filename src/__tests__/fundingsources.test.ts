/*
 * Code generated by Speakeasy (https://speakeasy.com). DO NOT EDIT.
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createTestHTTPClient } from "./testclient.js";

let fundingSourceId: string | undefined;

beforeAll(async () => {

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: createTestHTTPClient("fundingSources"),
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    }
  });

  const created = await dwolla.customers.fundingSources.create({
    id: "86d3ca4b-8c3c-4ba9-88fc-3be8243daf9d",
    createCustomerFundingSource: {
      name: "My virtual account",
      type: "virtual",
      bankAccountType: "checking",
    },
  });
  const locationHeader =
    created?.headers["Location"]?.[0] ?? created?.headers["location"]?.[0];
  expect(locationHeader).toBeDefined();
  fundingSourceId = new URL(locationHeader as string).pathname.split("/").pop();

});

test("Fundingsources Get Funding Source", async () => {
  const testHttpClient = createTestHTTPClient("getFundingSource");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.fundingSources.get({
    id: fundingSourceId!,
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.type).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
  if (result.type === "bank") {
    expect(result.bankAccountType).toBeDefined();
  }
  expect(result.name).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.removed).toBeDefined();
  expect(result.channels).toBeDefined();
});

test("Fundingsources Get Van Routing", async () => {
  const testHttpClient = createTestHTTPClient("getVanRouting");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.fundingSources.getVanRouting({
    id: fundingSourceId!,
  });
  expect(result).toBeDefined();
  expect(result.accountNumber).toBeDefined();
  expect(result.routingNumber).toBeDefined();
});

test("Fundingsources Update Or Remove Funding Source", async () => {
  const testHttpClient = createTestHTTPClient("updateOrRemoveFundingSource");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.fundingSources.updateOrRemove({
    id: fundingSourceId!,
    requestBody: {
      removed: true,
    },
  });
  expect(result).toBeDefined();
  expect(result).toEqual({});
});
