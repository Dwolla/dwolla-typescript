/*
 * Code generated by Speakeasy (https://speakeasy.com). DO NOT EDIT.
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createTestHTTPClient } from "./testclient.js";

let webhookId: string | undefined;

beforeAll(async () => {

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: createTestHTTPClient("webhookSubscriptions"),
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    }
  });

  const created = await dwolla.webhookSubscriptions.create({
    url: "http://myapplication.com/webhooks",
    secret: "mysecret",
  });
  const locationHeader =
    created?.headers["Location"]?.[0] ?? created?.headers["location"]?.[0];
  expect(locationHeader).toBeDefined();
  webhookId = new URL(locationHeader as string).pathname.split("/").pop();

});


test("Webhooksubscriptions List Webhook Subscriptions", async () => {
  const testHttpClient = createTestHTTPClient("listWebhookSubscriptions");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.webhookSubscriptions.list();
  expect(result).toBeDefined();
  // Assert structure rather than exact payload to tolerate real sandbox data
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.webhookSubscriptions ?? [])).toBe(true);
  if ((result.embedded?.webhookSubscriptions?.length ?? 0) > 0) {
    const first = result.embedded!.webhookSubscriptions![0]!;
    expect(first.id).toBeDefined();
    expect(first.url).toBeDefined();
    expect(typeof first.paused).toBe("boolean");
    expect(first.links).toBeDefined();
    expect(first.links?.self).toBeDefined();
    expect(first.links?.webhooks).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
  }
});

test("Webhooksubscriptions Get Webhook Subscription", async () => {
  const testHttpClient = createTestHTTPClient("getWebhookSubscription");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.webhookSubscriptions.get({
    id: webhookId?? "",
  });
  expect(result).toBeDefined();
  // Assert structure rather than exact payload to tolerate real sandbox data
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
  expect(result.links?.webhooks).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.url).toBeDefined();
  expect(typeof result.paused).toBe("boolean");
  expect(result.created).toBeInstanceOf(Date);
});

test("Webhooksubscriptions Update Webhook Subscription", async () => {
  const testHttpClient = createTestHTTPClient("updateWebhookSubscription");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.webhookSubscriptions.update({
    id: webhookId?? "",
    requestBody: {
      paused: true,
    },
  });
  expect(result).toBeDefined();
  // Assert structure rather than exact payload to tolerate real sandbox data
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
  expect(result.links?.webhooks).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.url).toBeDefined();
  expect(typeof result.paused).toBe("boolean");
  expect(result.created).toBeInstanceOf(Date);
});

test("Webhooksubscriptions Delete", async () => {
  const testHttpClient = createTestHTTPClient("delete");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });
  const result = await dwolla.webhookSubscriptions.delete({
    id: webhookId?? ""
  });
  expect(result).toBeDefined();
  // Assert structure of deleted subscription rather than exact payload
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
  expect(result.links?.webhooks).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.url).toBeDefined();
  expect(typeof result.paused).toBe("boolean");
  expect(result.created).toBeInstanceOf(Date);
});
