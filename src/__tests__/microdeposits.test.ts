/*
 * Code generated by Speakeasy (https://speakeasy.com). DO NOT EDIT.
 */

import { afterAll, beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createTestHTTPClient } from "./testclient.js";

let fundingSourceId: string | undefined;

beforeAll(async () => {
  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: createTestHTTPClient("microDeposits"),
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  try {
    const fundingSource = await dwolla.customers.fundingSources.create({
      id: "b2bedef2-2c66-4c4e-982d-1adcaa732b97",
      createCustomerFundingSource: {
        name: "My First Bank",
        bankAccountType: "checking",
        routingNumber: "222222226",
        accountNumber: "1234",
      },
    });

    const fsLocationHeader =
      fundingSource?.headers["Location"]?.[0] ?? fundingSource?.headers["location"]?.[0];
    fundingSourceId = new URL(fsLocationHeader as string).pathname.split("/").pop();
  } catch (error: any) {
    // If bank already exists, extract the ID from the error response
    if (error?.statusCode === 400 && error?.body?.includes("DuplicateResource")) {
      const bodyObj = JSON.parse(error.body);
      const existingHref = bodyObj._links?.about?.href;
      if (existingHref) {
        fundingSourceId = new URL(existingHref).pathname.split("/").pop();
      }
    } else {
      throw error;
    }
  }

  await dwolla.fundingSources.microDeposits.initiate({
    id: fundingSourceId!,
  });
});

afterAll(async () => {
  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: createTestHTTPClient("microDeposits-cleanup"),
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  // Clean up: remove the funding source
  await dwolla.fundingSources.updateOrRemove({
    id: fundingSourceId!,
    requestBody: {
      removed: true,
    },
  });
});

test("Microdeposits Get Micro Deposits", async () => {
  const testHttpClient = createTestHTTPClient("getMicroDeposits");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.fundingSources.microDeposits.get({
    id: fundingSourceId!,
  });
  expect(result).toBeDefined();
  // Assert structure rather than exact payload
  expect(result.created).toBeInstanceOf(Date);
  expect(result.status).toBeDefined();
  expect(result.links).toBeDefined();
  
  // Optional fields
  if (result.failure) {
    expect(result.failure.code).toBeDefined();
    expect(result.failure.description).toBeDefined();
  }
});

test("Microdeposits Verify Micro Deposits", async () => {
  const testHttpClient = createTestHTTPClient("verifyMicroDeposits");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.fundingSources.microDeposits.verify({
    id: fundingSourceId!,
    requestBody: {
      amount1: {
        value: "0.02",
        currency: "USD",
      },
      amount2: {
        value: "0.03",
        currency: "USD",
      },
    },
  });
  expect(result).toBeDefined();
  // Assert structure rather than exact payload
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
});
