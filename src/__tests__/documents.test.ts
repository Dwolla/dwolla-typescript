/*
 * Code originally generated by Speakeasy (https://www.speakeasy.com).
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createDwollaClient, createPersonalCustomer, extractIdFromLocationHeader } from "./setup.js";
import { filesToStream } from "./files.js";

// Path to test file - relative to project root (where tests are run from)
const testFilePath = "src/__tests__/mockserver/testdata/test-document-upload-success.png";

let dwolla: Dwolla;
let documentId: string | undefined;

beforeAll(async () => {
  dwolla = createDwollaClient("documents");
  
  // Create a business customer and upload a document
  const customerId = await createPersonalCustomer(dwolla);
  
  try {
    const docResult = await dwolla.customers.documents.create({
      id: customerId,
      requestBody: {
        documentType: "license",
        file: {
          fileName: "test-document.png",
          content: filesToStream(testFilePath),
        },
      },
    });
    documentId = extractIdFromLocationHeader(docResult?.headers);
  } catch {
    console.log("Note: Document upload failed");
  }
}, 30000); // 30 second timeout for setup initialization  

test("Documents Retrieve Document", async () => {
  
  const result = await dwolla.documents.get({
    id: documentId!,
  });
  expect(result).toBeDefined();
  // Assert structure rather than exact payload
  expect(result.id).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.type).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
  
  // Optional fields
  if (result.documentVerificationStatus) {
    expect(typeof result.documentVerificationStatus).toBe("string");
  }
  if (result.failureReason) {
    expect(typeof result.failureReason).toBe("string");
  }
  if (result.allFailureReasons) {
    expect(Array.isArray(result.allFailureReasons)).toBe(true);
  }
});
