/*
 * Code originally generated by Speakeasy (https://www.speakeasy.com).
 * Consolidated label tests - covers labels, ledger entries, reallocations, and customer labels.
 * Creates labels on a single customer and uses them for all tests.
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createDwollaClient, createPersonalCustomer, extractIdFromLocationHeader, createVerifiedBankFundingSource, getBalanceFundingSourceId } from "./setup.js";

let dwolla: Dwolla;
let customerId: string;
let labelId: string | undefined;
let labelId2: string | undefined;
let ledgerEntryId: string | undefined;
let reallocationId: string | undefined;

beforeAll(async () => {
  dwolla = createDwollaClient("labels");
  
  // Create a personal customer for label testing
  customerId = await createPersonalCustomer(dwolla);

  // Get the customer's balance funding source
  const balanceFsId = await getBalanceFundingSourceId(dwolla, customerId);
  if (!balanceFsId) {
    console.log("Note: Could not find balance funding source for customer");
    return;
  }

  // Create a verified bank funding source
  const bankFsId = await createVerifiedBankFundingSource(dwolla, customerId, "Labels Test Bank");

  // Transfer funds from the bank to the balance (needed for labels)
  try {
    const transferResult = await dwolla.transfers.create({
      requestBody: {
        links: {
          source: {
            href: `https://api-sandbox.dwolla.com/funding-sources/${bankFsId}`,
          },
          destination: {
            href: `https://api-sandbox.dwolla.com/funding-sources/${balanceFsId}`,
          },
        },
        amount: {
          currency: "USD",
          value: "20.00", // Enough for both labels
        },
      },
    });
    const transferId = extractIdFromLocationHeader(transferResult?.headers);
    
    // In sandbox, simulate bank transfer processing to complete the transfer immediately
    if (transferId) {
      await dwolla.sandboxSimulations.simulate();
    }
  } catch (e) {
    console.log("Note: Could not transfer funds to balance:", e);
    return;
  }

  // Create first label
  try {
    const created = await dwolla.customers.labels.create({
      id: customerId,
      requestBody: {
        amount: {
          value: "10.00",
          currency: "USD",
        },
      },
    });
    labelId = extractIdFromLocationHeader(created?.headers);
    
    // Get first ledger entry ID from the label (created automatically)
    if (labelId) {
      const entries = await dwolla.labels.ledgerEntries.list({ id: labelId });
      ledgerEntryId = entries.embedded?.ledgerEntries?.[0]?.id;
    }
    
    // Create second label for reallocation tests
    const created2 = await dwolla.customers.labels.create({
      id: customerId,
      requestBody: {
        amount: {
          value: "5.00",
          currency: "USD",
        },
      },
    });
    labelId2 = extractIdFromLocationHeader(created2?.headers);
    
    // Create a reallocation between the two labels
    if (labelId && labelId2) {
      try {
        const reallocationResult = await dwolla.labels.reallocations.create({
          links: {
            from: {
              href: `https://api-sandbox.dwolla.com/labels/${labelId}`,
            },
            to: {
              href: `https://api-sandbox.dwolla.com/labels/${labelId2}`,
            },
          },
          amount: {
            value: "1.00",
            currency: "USD",
          },
        });
        reallocationId = extractIdFromLocationHeader(reallocationResult?.headers);
      } catch {
        // Reallocation may fail in some scenarios
        console.log("Note: Could not create reallocation");
      }
    }
  } catch (e) {
    console.log("Note: Could not create labels:", e);
  }
}, 30000);

// ============================================================================
// CUSTOMER LABELS TESTS
// ============================================================================

test("Labels List Customer Labels", async () => {
  const result = await dwolla.customers.labels.list({
    id: customerId,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.labels ?? [])).toBe(true);
  expect(typeof result.total).toBe("number");

  if ((result.embedded?.labels?.length ?? 0) > 0) {
    const first = result.embedded!.labels![0]!;
    expect(first.id).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
    expect(first.amount).toBeDefined();
    expect(first.amount?.value).toBeDefined();
    expect(first.amount?.currency).toBeDefined();
    expect(first.links).toBeDefined();
    expect(first.links?.["self"]).toBeDefined();
  }
});

// ============================================================================
// LABELS TESTS
// ============================================================================

test("Labels Get Label", async () => {

  const result = await dwolla.labels.get({
    id: labelId!,
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.amount).toBeDefined();
  expect(result.amount?.value).toBeDefined();
  expect(result.amount?.currency).toBe("USD");
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
});

// ============================================================================
// LEDGER ENTRIES TESTS
// ============================================================================

test("Labels List Label Ledger Entries", async () => {

  const result = await dwolla.labels.ledgerEntries.list({
    id: labelId!,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.ledgerEntries ?? [])).toBe(true);
  expect(typeof result.total).toBe("number");

  if ((result.embedded?.ledgerEntries?.length ?? 0) > 0) {
    const first = result.embedded!.ledgerEntries![0]!;
    expect(first.id).toBeDefined();
    expect(first.amount).toBeDefined();
    expect(first.amount?.value).toBeDefined();
    expect(first.amount?.currency).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
    expect(first.links).toBeDefined();
  }
});

test("Labels Get Label Ledger Entry", async () => {

  const result = await dwolla.labels.ledgerEntries.get({
    ledgerEntryId: ledgerEntryId!,
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.amount).toBeDefined();
  expect(result.amount?.value).toBeDefined();
  expect(result.amount?.currency).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
});

// ============================================================================
// REALLOCATIONS TESTS
// ============================================================================

test("Labels Retrieve Label Reallocation", async () => {

  const result = await dwolla.labels.reallocations.get({
    reallocationId: reallocationId!,
  });
  expect(result).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
  expect(result.links?.toLedgerEntry).toBeDefined();
  expect(result.links?.fromLedgerEntry).toBeDefined();
});

// ============================================================================
// LABELS REMOVE TEST (runs last since it removes the label)
// ============================================================================

test("Labels Remove Label", async () => {

  // First zero out the label balance with a negative ledger entry
  // Get current balance first
  const label = await dwolla.labels.get({ id: labelId! });
  const currentValue = parseFloat(label.amount?.value ?? "0");
  
  if (currentValue > 0) {
    await dwolla.labels.ledgerEntries.create({
      id: labelId!,
      requestBody: {
        amount: {
          value: `-${currentValue.toFixed(2)}`,
          currency: "USD",
        },
      },
    });
  }

  // Remove the label
  const result = await dwolla.labels.remove({
    id: labelId!,
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.amount).toBeDefined();
  expect(result.amount?.value).toBeDefined();
  expect(result.amount?.currency).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
});
