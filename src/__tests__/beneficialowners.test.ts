/*
 * Code originally generated by Speakeasy (https://www.speakeasy.com).
 * Consolidated beneficial owner tests - covers all beneficial owner operations.
 * Creates a single business customer and uses it for all beneficial owner tests.
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createDwollaClient, createBusinessCustomer, extractIdFromLocationHeader } from "./setup.js";
import { filesToStream } from "./files.js";

const testFilePath = "src/__tests__/mockserver/testdata/test-document-upload-success.png";

let dwolla: Dwolla;
let businessCustomerId: string;
let beneficialOwnerId: string | undefined;
let beneficialOwnerForDocsId: string | undefined;

beforeAll(async () => {
  dwolla = createDwollaClient("beneficialowners");
  
  // Create a single business customer for all beneficial owner tests
  businessCustomerId = await createBusinessCustomer(dwolla);

  // Create a beneficial owner for CRUD tests
  const createResult = await dwolla.customers.beneficialOwners.create({
    id: businessCustomerId,
    requestBody: {
      firstName: "incomplete",
      lastName: "Owner",
      dateOfBirth: "1970-01-01",
      address: {
        address1: "123 Main St",
        city: "Des Moines",
        stateProvinceRegion: "IA",
        country: "US",
        postalCode: "50309",
      },
      ssn: "123456789",
    },
  });
  beneficialOwnerId = extractIdFromLocationHeader(createResult?.headers);

  // Create a separate beneficial owner for document tests (won't be deleted)
  const createDocsResult = await dwolla.customers.beneficialOwners.create({
    id: businessCustomerId,
    requestBody: {
      firstName: "document",
      lastName: "Test",
      dateOfBirth: "1975-05-15",
      address: {
        address1: "789 Document Ave",
        city: "Des Moines",
        stateProvinceRegion: "IA",
        country: "US",
        postalCode: "50309",
      },
      ssn: "987654321",
    },
  });
  beneficialOwnerForDocsId = extractIdFromLocationHeader(createDocsResult?.headers);

  // Upload a document for the docs beneficial owner
  if (beneficialOwnerForDocsId) {
    try {
      await dwolla.beneficialOwners.documents.create({
        id: beneficialOwnerForDocsId,
        requestBody: {
          documentType: "license",
          file: {
            fileName: "test-document-upload-success.png",
            content: filesToStream(testFilePath),
          },
        },
      });
    } catch {
      console.log("Note: Document upload skipped (may already exist)");
    }
  }
}, 30000);

// ============================================================================
// BENEFICIAL OWNERSHIP STATUS TESTS
// ============================================================================

test("Beneficialowners Get Beneficial Ownership Status For Business Customer", async () => {
  const result = await dwolla.customers.beneficialOwnership.get({
    id: businessCustomerId,
  });
  expect(result).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
});

test("Beneficialowners Certify Beneficial Ownership For Customer", async () => {
  const result = await dwolla.customers.beneficialOwnership.certify({
    id: businessCustomerId,
    requestBody: {
      status: "certified",
    },
  });
  expect(result).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
});

// ============================================================================
// CUSTOMER BENEFICIAL OWNERS LIST TESTS
// ============================================================================

test("Beneficialowners Beneficialowners List Beneficial Owners For Customer", async () => {
  const result = await dwolla.customers.beneficialOwners.list({
    id: businessCustomerId,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.beneficialOwners ?? [])).toBe(true);

  if ((result.embedded?.beneficialOwners?.length ?? 0) > 0) {
    const first = result.embedded!.beneficialOwners![0]!;
    expect(first.id).toBeDefined();
    expect(first.firstName).toBeDefined();
    expect(first.lastName).toBeDefined();
    expect(first.verificationStatus).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
    expect(first.links).toBeDefined();
    expect(first.links?.["self"]).toBeDefined();
    expect(first.address).toBeDefined();
    expect(first.address?.address1).toBeDefined();
    expect(first.address?.city).toBeDefined();
    expect(first.address?.country).toBeDefined();
  }
});

// ============================================================================
// BENEFICIAL OWNER CRUD TESTS
// ============================================================================

test("Beneficialowners Retrieve Beneficial Owner", async () => {

  const result = await dwolla.beneficialOwners.get({
    id: beneficialOwnerId!,
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.firstName).toBeDefined();
  expect(result.lastName).toBeDefined();
  expect(result.verificationStatus).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.address).toBeDefined();
  expect(result.address?.address1).toBeDefined();
  expect(result.address?.city).toBeDefined();
  expect(result.address?.country).toBeDefined();
});

test("Beneficialowners Update Beneficial Owner", async () => {

  const result = await dwolla.beneficialOwners.update({
    id: beneficialOwnerId!,
    requestBody: {
      firstName: "Updated",
      lastName: "Owner",
      dateOfBirth: "1970-01-01",
      address: {
        address1: "462 Main Street",
        address2: "Suite 123",
        address3: "Unit 123",
        city: "Des Moines",
        postalCode: "50309",
        country: "US",
        stateProvinceRegion: "IA",
      },
      ssn: "123-45-6789",
    },
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.firstName).toBeDefined();
  expect(result.lastName).toBeDefined();
  expect(result.verificationStatus).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.address).toBeDefined();
});

// ============================================================================
// BENEFICIAL OWNER DOCUMENTS TESTS
// ============================================================================

test("Beneficialowners Documents List Beneficial Owner Documents", async () => {

  const result = await dwolla.beneficialOwners.documents.list({
    id: beneficialOwnerForDocsId!,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.documents ?? [])).toBe(true);
  expect(typeof result.total).toBe("number");

  if ((result.embedded?.documents?.length ?? 0) > 0) {
    const first = result.embedded!.documents![0]!;
    expect(first.id).toBeDefined();
    expect(first.status).toBeDefined();
    expect(first.type).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
    expect(first.links).toBeDefined();
    expect(first.links?.self).toBeDefined();
  }
});

// ============================================================================
// DELETE TEST (runs last)
// ============================================================================

test("Beneficialowners Delete Beneficial Owner", async () => {

  const result = await dwolla.beneficialOwners.delete({
    id: beneficialOwnerId!,
  });
  expect(result).toBeDefined();
  // Delete returns an empty object on success
});

