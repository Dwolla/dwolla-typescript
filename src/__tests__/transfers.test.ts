/*
 * Code originally generated by Speakeasy (https://www.speakeasy.com).
 */

import { expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createTestHTTPClient } from "./testclient.js";

test("Transfers Get Transfer", async () => {
  const testHttpClient = createTestHTTPClient("getTransfer");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.transfers.get({
    id: "5cefc1b4-c2ce-f011-acd5-02ab38c54207",
  });
  expect(result).toBeDefined();
  // Assert structure rather than exact payload to tolerate real sandbox data
  expect(result.id).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.amount).toBeDefined();
  expect(result.amount?.value).toBeDefined();
  expect(result.amount?.currency).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
  expect(result.links?.["source"]).toBeDefined();
  expect(result.links?.["destination"]).toBeDefined();
  
  // Optional fields - only check if present
  if (result.clearing) {
    expect(result.clearing.source).toBeDefined();
  }
  if (result.correlationId) {
    expect(typeof result.correlationId).toBe("string");
  }
  if (result.metadata) {
    expect(typeof result.metadata).toBe("object");
  }
  if (result.achDetails) {
    expect(typeof result.achDetails).toBe("object");
  }
  if (result.rtpDetails) {
    expect(typeof result.rtpDetails).toBe("object");
  }
  if (result.fedNowDetails) {
    expect(typeof result.fedNowDetails).toBe("object");
  }
  if (result.processingChannel) {
    expect(typeof result.processingChannel).toBe("object");
  }
});

test("Transfers Cancel Transfer", async () => {
  const testHttpClient = createTestHTTPClient("cancelTransfer");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  // create a transfer to cancel in this test
  const createTransferResult = await dwolla.transfers.create({
    requestBody: {
      links: {
        source: {
          href: "https://api-sandbox.dwolla.com/funding-sources/e68fa049-56b8-4795-84b7-fa15906f2037",
        },
        destination: {  
          href: "https://api-sandbox.dwolla.com/funding-sources/fbc97298-c9c9-4b45-a10b-8c40473542f7",
        },
      },
      amount: {
        value: "250.50",
        currency: "USD",
      },
    },
  });

  const locationHeader =
    createTransferResult?.headers["Location"]?.[0] ?? createTransferResult?.headers["location"]?.[0];
  expect(locationHeader).toBeDefined();
  const transferId = new URL(locationHeader as string).pathname.split("/").pop();

  const result = await dwolla.transfers.cancel({
    id: transferId!,
    requestBody: {
      status: "cancelled",
    },
  });
  expect(result).toBeDefined();
  // Cancel operation returns an empty object on success
});