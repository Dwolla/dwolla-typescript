/*
 * Code generated by Speakeasy (https://speakeasy.com). DO NOT EDIT.
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createTestHTTPClient } from "./testclient.js";

let massPaymentId: string | undefined;

beforeAll(async () => {
  const testHttpClient = createTestHTTPClient("getMassPayment");
  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });
  const result = await dwolla.massPayments.create({
    requestBody:{
      links: {
        source: {
          href: "https://api-sandbox.dwolla.com/funding-sources/daeec1c1-c54a-4ec2-93aa-5ae0aab23a03",
        },
      },
      items: [
        {
          links: {
            destination: {
              href: "https://api-sandbox.dwolla.com/funding-sources/e417ab60-a3e0-4043-9646-29f2c782c993",
            },
          },
          amount: {
            value: "100",
            currency: "USD",
          },
          clearing: {
            destination: "next-available",
          },
          achDetails: {
            destination: {
              addenda: {
                values: ["EMP001 PAYROLL 2025-12-02"],
              },
            },
          }
        },
        {
          links: {
            destination: {
              href: "https://api-sandbox.dwolla.com/funding-sources/e417ab60-a3e0-4043-9646-29f2c782c993",
            },
          },
          amount: {
            value: "200",
            currency: "USD",
          },
          clearing: {
            destination: "next-available",
          },
          achDetails: {
            destination: {
              addenda: {
                values: ["EMP002 PAYROLL 2025-12-02"],
              },
            },
          }
        },
      ],
      status: "deferred",
      clearing: {
        source: "next-available",
      },
      achDetails: {
        source: {
          addenda: {
            values: ["BATCH REF 12345"],
          },
        },
      },
    }
  });

  const locationHeader =
    result?.headers["Location"]?.[0] ?? result?.headers["location"]?.[0];
  expect(locationHeader).toBeDefined();
  massPaymentId = new URL(locationHeader as string).pathname.split("/").pop();
});

test("Masspayments Get Mass Payment", async () => {
  const testHttpClient = createTestHTTPClient("getMassPayment");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.massPayments.get({
    id: massPaymentId!,
  });
  expect(result).toBeDefined();
  // Assert structure rather than exact payload
  expect(result.id).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.total).toBeDefined();
  expect(result.total?.value).toBeDefined();
  expect(result.total?.currency).toBeDefined();
  
  // Optional fields
  if (result.totalFees) {
    expect(result.totalFees.value).toBeDefined();
    expect(result.totalFees.currency).toBeDefined();
  }
  if (result.correlationId) {
    expect(typeof result.correlationId).toBe("string");
  }
});

test("Masspayments Update Mass Payment", async () => {
  const testHttpClient = createTestHTTPClient("updateMassPayment");

  const dwolla = new Dwolla({
    serverURL: "https://api-sandbox.dwolla.com",
    httpClient: testHttpClient,
    security: {
      clientID: process.env["DWOLLA_CLIENT_ID"] ?? "value",
      clientSecret: process.env["DWOLLA_CLIENT_SECRET"] ?? "value",
    },
  });

  const result = await dwolla.massPayments.update({
    id: massPaymentId!,
    requestBody: {
      status: "cancelled",
    },
  });
  expect(result).toBeDefined();
  // Assert structure rather than exact payload
  expect(result.id).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.total).toBeDefined();
  expect(result.total?.value).toBeDefined();
  expect(result.total?.currency).toBeDefined();
  
  // Optional fields
  if (result.totalFees) {
    expect(result.totalFees.value).toBeDefined();
    expect(result.totalFees.currency).toBeDefined();
  }
  if (result.correlationId) {
    expect(typeof result.correlationId).toBe("string");
  }
});
