/*
 * Code originally generated by Speakeasy (https://www.speakeasy.com).
 * Consolidated mass payments tests - covers mass payments and items.
 * Creates a single mass payment and uses it for all tests.
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createDwollaClient, createPersonalCustomer, getBalanceFundingSourceId, extractIdFromLocationHeader, createVerifiedBankFundingSource } from "./setup.js";

let dwolla: Dwolla;
let massPaymentId: string | undefined;
let massPaymentItemId: string | undefined;

beforeAll(async () => {
  dwolla = createDwollaClient("masspayments");
  
  // Create a business customer with funding sources
  const customerId = await createPersonalCustomer(dwolla);
  const balanceFsId = await getBalanceFundingSourceId(dwolla, customerId);
  const bankFsId = await createVerifiedBankFundingSource(dwolla, customerId, "Mass Payment Test Bank");
  
  try {
    // Create a mass payment (deferred so we can process or cancel it later)
    const result = await dwolla.massPayments.create({
      requestBody: {
        links: {
          source: {
            href: `https://api-sandbox.dwolla.com/funding-sources/${bankFsId}`,
          },
        },
        items: [
          {
            links: {
              destination: {
                href: `https://api-sandbox.dwolla.com/funding-sources/${balanceFsId}`,
              },
            },
            amount: {
              value: "1.00",
              currency: "USD",
            },
          },
        ],
        status: "deferred",
      },
    });

    massPaymentId = extractIdFromLocationHeader(result?.headers);
    
    // Get the first item ID from the mass payment
    if (massPaymentId) {
      const items = await dwolla.massPayments.items.list({ id: massPaymentId });
      massPaymentItemId = items.embedded?.items?.[0]?.id;
    }
  } catch (e) {
    console.log("Note: Could not create mass payment:", e);
  }
}, 30000);

// ============================================================================
// MASS PAYMENTS TESTS
// ============================================================================

test("Masspayments Get Mass Payment", async () => {

  const result = await dwolla.massPayments.get({
    id: massPaymentId!,
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.total).toBeDefined();
  expect(result.total?.value).toBeDefined();
  expect(result.total?.currency).toBeDefined();
  
  if (result.totalFees) {
    expect(result.totalFees.value).toBeDefined();
    expect(result.totalFees.currency).toBeDefined();
  }
  if (result.correlationId) {
    expect(typeof result.correlationId).toBe("string");
  }
});

test("Masspayments Update Mass Payment", async () => {

  const result = await dwolla.massPayments.update({
    id: massPaymentId!,
    requestBody: {
      status: "pending",
    },
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.links).toBeDefined();
  expect(result.total).toBeDefined();
  expect(result.total?.value).toBeDefined();
  expect(result.total?.currency).toBeDefined();
});

// ============================================================================
// MASS PAYMENT ITEMS TESTS
// ============================================================================

test("Masspayments List Mass Payment Items", async () => {

  const result = await dwolla.massPayments.items.list({
    id: massPaymentId!,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.items ?? [])).toBe(true);
  expect(typeof result.total).toBe("number");

  if ((result.embedded?.items?.length ?? 0) > 0) {
    const first = result.embedded!.items![0]!;
    expect(first.id).toBeDefined();
    expect(first.status).toBeDefined();
    expect(first.amount).toBeDefined();
    expect(first.amount?.value).toBeDefined();
    expect(first.amount?.currency).toBeDefined();
    expect(first.links).toBeDefined();
    expect(first.links?.self).toBeDefined();
    expect(first.links?.massPayment).toBeDefined();
    expect(first.links?.destination).toBeDefined();
  }
});

test("Masspayments Get Mass Payment Item", async () => {

  const result = await dwolla.massPayments.items.get({
    itemId: massPaymentItemId!,
  });
  expect(result).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.status).toBeDefined();
  expect(result.amount).toBeDefined();
  expect(result.amount?.value).toBeDefined();
  expect(result.amount?.currency).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.self).toBeDefined();
  expect(result.links?.massPayment).toBeDefined();
  expect(result.links?.destination).toBeDefined();
});

