/*
 * Code originally generated by Speakeasy (https://www.speakeasy.com).
 * 
 * Skipped: KBA tests require a feature flag that must be manually enabled by Dwolla.
 * These tests have been verified and work correctly when KBA is enabled.
 */

import { beforeAll, describe, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createDwollaClient, extractIdFromLocationHeader } from "./setup.js";   

// Skip entire suite - KBA requires feature flag enabled by Dwolla
describe.skip("KBA Tests", () => {
  let dwolla: Dwolla;
  let customerId: string | undefined;
  let kbaSessionId: string | undefined;

  beforeAll(async () => {
    dwolla = createDwollaClient("kba");
    // Create a Personal Verified Customer with firstName "kba" to trigger KBA status
    const timestamp = Date.now();
    const customerResult = await dwolla.customers.create({
      firstName: "kba",
      lastName: "Test",
      email: `kba-test-${timestamp}@example.com`,
      type: "personal",
      address1: "123 Main St",
      city: "Des Moines",
      state: "IA",
      postalCode: "50309",
      dateOfBirth: "1980-01-01",
      ssn: "1234",
    });
    customerId = await extractIdFromLocationHeader(customerResult?.headers);

    const kbaResult = await dwolla.customers.kba.initiate({
      id: customerId!,
    });
    kbaSessionId = extractIdFromLocationHeader(kbaResult?.headers);
  }, 30000);

  test("Kba Get Kba Questions", async () => {
    const result = await dwolla.kba.getQuestions({
      id: kbaSessionId!,
    });
    expect(result).toBeDefined();
    expect(result.id).toBeDefined();
    expect(result.links).toBeDefined();
    expect(result.links?.answer).toBeDefined();
    expect(Array.isArray(result.questions ?? [])).toBe(true);
    
    if ((result.questions?.length ?? 0) > 0) {
      const first = result.questions![0]!;
      expect(first.id).toBeDefined();
      expect(first.text).toBeDefined();
      expect(Array.isArray(first.answers ?? [])).toBe(true);
      
      if ((first.answers?.length ?? 0) > 0) {
        const firstAnswer = first.answers![0]!;
        expect(firstAnswer.id).toBeDefined();
        expect(firstAnswer.text).toBeDefined();
      }
    }
  });

  test("Kba Verify Kba Questions", async () => {
    const result = await dwolla.kba.verify({
      id: kbaSessionId!,
      requestBody: {
        answers: [
          { questionId: "2355953375", answerId: "2687969335" },
          { questionId: "2355953385", answerId: "2687969385" },
          { questionId: "2355953395", answerId: "2687969435" },
          { questionId: "2355953405", answerId: "2687969485" },
        ],
      },
    });
    expect(result).toBeDefined();
    expect(result.verificationStatus).toBeDefined();
    expect(result.links).toBeDefined();
    expect(result.links?.customer).toBeDefined();
  });
});
