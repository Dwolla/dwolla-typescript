/*
 * Code originally generated by Speakeasy (https://www.speakeasy.com).
 * Consolidated customer tests - covers customers and their sub-resources.
 * Creates a single business customer for business-specific tests and
 * a single personal customer for personal-specific tests.
 */

import { beforeAll, expect, test } from "vitest";
import { Dwolla } from "../index.js";
import { createDwollaClient, createBusinessCustomer, createPersonalCustomer } from "./setup.js";

let dwolla: Dwolla;
let businessCustomerId: string;
let personalCustomerId: string;

beforeAll(async () => {
  dwolla = createDwollaClient("customers");
  
  // Create a business customer for business-specific tests
  businessCustomerId = await createBusinessCustomer(dwolla);
  
  // Create a personal customer for personal-specific tests
  personalCustomerId = await createPersonalCustomer(dwolla);
}, 30000);

// ============================================================================
// CORE CUSTOMER TESTS
// ============================================================================

test("Customers List And Search Customers", async () => {
  const result = await dwolla.customers.list({});
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.customers ?? [])).toBe(true);
  
  if ((result.embedded?.customers?.length ?? 0) > 0) {
    const first = result.embedded!.customers![0]!;
    expect(first.id).toBeDefined();
    expect(first.firstName).toBeDefined();
    expect(first.lastName).toBeDefined();
    expect(first.email).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
    expect(first.type).toBeDefined();
    expect(first.status).toBeDefined();
  }
});

test("Customers Get Customer", async () => {
  const result = await dwolla.customers.get({
    id: businessCustomerId,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.firstName).toBeDefined();
  expect(result.lastName).toBeDefined();
  expect(result.email).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.type).toBeDefined();
  expect(result.status).toBeDefined();
});

test("Customers Update", async () => {
  const result = await dwolla.customers.update({
    id: businessCustomerId,
    requestBody: {
      operationType: "UpdateVerifiedBusiness",
      address1: "1 Hagrid's Hut",
      city: "Des Moines",
      state: "IA",
      postalCode: "50266",
    },
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.id).toBeDefined();
  expect(result.firstName).toBeDefined();
  expect(result.lastName).toBeDefined();
  expect(result.email).toBeDefined();
  expect(result.created).toBeInstanceOf(Date);
  expect(result.type).toBeDefined();
  expect(result.status).toBeDefined();
});

// ============================================================================
// CUSTOMER DOCUMENTS TESTS
// ============================================================================

test("Customers Documents List Business Customer Documents", async () => {
  const result = await dwolla.customers.documents.list({
    id: businessCustomerId,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.documents ?? [])).toBe(true);
  expect(typeof result.total).toBe("number");

  if ((result.embedded?.documents?.length ?? 0) > 0) {
    const first = result.embedded!.documents![0]!;
    expect(first.id).toBeDefined();
    expect(first.status).toBeDefined();
    expect(first.type).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
    expect(first.links).toBeDefined();
    expect(first.links?.self).toBeDefined();
  }
});

// ============================================================================
// CUSTOMER FUNDING SOURCES TESTS
// ============================================================================

test("Customers Fundingsources List Customer Funding Sources", async () => {
  const result = await dwolla.customers.fundingSources.list({
    id: personalCustomerId,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.fundingSources ?? [])).toBe(true);

  if ((result.embedded?.fundingSources?.length ?? 0) > 0) {
    const first = result.embedded!.fundingSources![0]!;
    expect(first.id).toBeDefined();
    expect(first.status).toBeDefined();
    expect(first.type).toBeDefined();
    expect(first.name).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
    expect(first.links).toBeDefined();
    expect(first.links?.["self"]).toBeDefined();
    expect(typeof first.removed).toBe("boolean");
    expect(Array.isArray(first.channels ?? [])).toBe(true);
  }
});

// ============================================================================
// CUSTOMER MASS PAYMENTS TESTS
// ============================================================================

test("Customers Masspayments List Customer Mass Payments", async () => {
  const result = await dwolla.customers.massPayments.list({
    id: personalCustomerId,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.massPayments ?? [])).toBe(true);
  expect(typeof result.total).toBe("number");

  if ((result.embedded?.massPayments?.length ?? 0) > 0) {
    const first = result.embedded!.massPayments![0]!;
    expect(first.id).toBeDefined();
    expect(first.status).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
    expect(first.links).toBeDefined();
    expect(first.total).toBeDefined();
    expect(first.total?.value).toBeDefined();
    expect(first.total?.currency).toBeDefined();
  }
});

// ============================================================================
// CUSTOMER TRANSFERS TESTS
// ============================================================================

test("Customers Transfers List Customer Transfers", async () => {
  const result = await dwolla.customers.transfers.list({
    id: personalCustomerId,
  });
  expect(result).toBeDefined();
  expect(result.links).toBeDefined();
  expect(result.links?.["self"]).toBeDefined();
  expect(result.embedded).toBeDefined();
  expect(Array.isArray(result.embedded?.transfers ?? [])).toBe(true);
  expect(typeof result.total).toBe("number");

  if ((result.embedded?.transfers?.length ?? 0) > 0) {
    const first = result.embedded!.transfers![0]!;
    expect(first.id).toBeDefined();
    expect(first.status).toBeDefined();
    expect(first.created).toBeInstanceOf(Date);
    expect(first.amount).toBeDefined();
    expect(first.amount?.value).toBeDefined();
    expect(first.amount?.currency).toBeDefined();
    expect(first.links).toBeDefined();
    expect(first.links?.["self"]).toBeDefined();
  }
});

